generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["metrics"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id       String @id @default(uuid())
  email    String @unique
  password String
  name     String

  // User preferences
  timezone String @default("UTC") // IANA timezone (e.g., "Asia/Kolkata")

  // API Access for future integrations (WhatsApp, automations, etc.)
  apiKey          String?   @unique
  apiKeyCreatedAt DateTime?
  apiKeyScopes    String[]  @default(["bot:read", "bot:write"])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  habits               Habit[]
  habitLogs            HabitLog[]
  milestones           Milestone[]
  books                Book[]
  challenges           Challenge[]
  challengeProgress    ChallengeProgress[]
  refreshTokens        RefreshToken[]
  connectedApps        ConnectedApp[]
  habitReminders       HabitReminder[]
  notificationSettings UserNotificationSettings?

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model LoginAttempt {
  id          String    @id @default(uuid())
  email       String    @unique
  failedCount Int       @default(0)
  lockedUntil DateTime?
  lastAttempt DateTime  @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([email])
  @@index([lockedUntil])
  @@map("login_attempts")
}

model Habit {
  id          String  @id @default(uuid())
  userId      String
  name        String
  description String?

  // Frequency configuration
  frequency    Frequency @default(DAILY)
  daysOfWeek   Int[] // For weekly: specific days [1,3,5] = Mon,Wed,Fri (1=Mon, 7=Sun)
  timesPerWeek Int? // For weekly: X times per week (any days)

  // Habit type configuration
  habitType   HabitType @default(BOOLEAN)
  targetValue Int? // For NUMERIC/DURATION: target goal (e.g., 8 glasses, 30 minutes)
  unit        String? // For NUMERIC/DURATION: unit label (e.g., "glasses", "minutes")

  // Display & Organization
  color     String  @default("#0ea5e9")
  icon      String?
  category  String?
  sortOrder Int     @default(0) // For drag-and-drop ordering

  // Status
  isActive   Boolean @default(true)
  isArchived Boolean @default(false) // Archived habits (keep history, hide from view)

  // Pause/Vacation Mode
  isPaused    Boolean   @default(false)
  pausedAt    DateTime?
  pausedUntil DateTime? // Auto-resume date (optional)
  pauseReason String? // Optional reason for pausing

  // Habit Stacking/Chaining
  stackedAfterHabitId String? // The habit this one comes after
  stackedAfterHabit   Habit?  @relation("HabitStack", fields: [stackedAfterHabitId], references: [id], onDelete: SetNull)
  stackedBeforeHabits Habit[] @relation("HabitStack")

  // Template reference (if created from template)
  templateId String?

  // Streak tracking (denormalized for performance)
  currentStreak    Int       @default(0)
  longestStreak    Int       @default(0)
  totalCompletions Int       @default(0)
  lastCompletedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  template        HabitTemplate?   @relation(fields: [templateId], references: [id])
  habitLogs       HabitLog[]
  milestones      Milestone[]
  challengeHabits ChallengeHabit[]
  reminder        HabitReminder?

  @@index([userId])
  @@index([userId, isActive, isArchived])
  @@index([category])
  @@index([userId, sortOrder])
  @@index([stackedAfterHabitId])
  @@map("habits")
}

model HabitLog {
  id        String   @id @default(uuid())
  habitId   String
  userId    String
  date      DateTime @db.Date // Store as date only, no time component
  completed Boolean  @default(true)
  value     Int? // For NUMERIC/DURATION habits: actual value achieved
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([habitId, date])
  @@index([habitId])
  @@index([userId])
  @@index([date])
  @@index([userId, date])
  @@map("habit_logs")
}

model Milestone {
  id         String        @id @default(uuid())
  habitId    String
  userId     String
  type       MilestoneType
  value      Int // The milestone value (7, 30, 100, etc.)
  achievedAt DateTime      @default(now())

  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([habitId, type, value]) // Prevent duplicate milestones
  @@index([habitId])
  @@index([userId])
  @@index([achievedAt])
  @@map("milestones")
}

// ============ HABIT TEMPLATES ============

model HabitTemplate {
  id          String    @id @default(uuid())
  name        String
  description String?
  category    String
  icon        String?
  color       String    @default("#0ea5e9")
  habitType   HabitType @default(BOOLEAN)
  targetValue Int?
  unit        String?
  frequency   Frequency @default(DAILY)
  isSystem    Boolean   @default(true) // System templates vs user-created

  createdAt DateTime @default(now())

  habits Habit[]

  @@map("habit_templates")
}

// ============ BOOK READING TRACKER ============

model Book {
  id          String  @id @default(uuid())
  userId      String
  title       String
  author      String?
  coverUrl    String? // Book cover image URL
  totalPages  Int?
  currentPage Int     @default(0)

  status BookStatus @default(WANT_TO_READ)
  rating Int? // 1-5 stars
  notes  String? // Personal notes/review

  startedAt  DateTime?
  finishedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  readingLogs ReadingLog[]

  @@index([userId])
  @@index([userId, status])
  @@map("books")
}

model ReadingLog {
  id        String   @id @default(uuid())
  bookId    String
  date      DateTime @db.Date
  pagesRead Int
  notes     String?
  createdAt DateTime @default(now())

  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([bookId, date])
  @@index([bookId])
  @@index([date])
  @@map("reading_logs")
}

// ============ CHALLENGES ============

model Challenge {
  id          String  @id @default(uuid())
  userId      String
  name        String
  description String?

  // Duration
  duration  Int // Number of days (e.g., 30 for 30-day challenge)
  startDate DateTime @db.Date
  endDate   DateTime @db.Date

  // Status
  status ChallengeStatus @default(ACTIVE)

  // Results (calculated when completed)
  completionRate Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  habits   ChallengeHabit[]
  progress ChallengeProgress[]

  @@index([userId])
  @@index([userId, status])
  @@map("challenges")
}

model ChallengeHabit {
  id          String @id @default(uuid())
  challengeId String
  habitId     String

  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  habit     Habit     @relation(fields: [habitId], references: [id], onDelete: Cascade)

  @@unique([challengeId, habitId])
  @@index([habitId])
  @@map("challenge_habits")
}

model ChallengeProgress {
  id          String   @id @default(uuid())
  challengeId String
  userId      String
  date        DateTime @db.Date

  // Daily stats for the challenge
  habitsCompleted Int @default(0)
  habitsTotal     Int @default(0)

  createdAt DateTime @default(now())

  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([challengeId, date])
  @@index([challengeId])
  @@index([userId])
  @@index([userId, date])
  @@map("challenge_progress")
}

// ============ INTEGRATIONS & REMINDERS ============

model ConnectedApp {
  id        String   @id @default(uuid())
  userId    String
  provider  String // 'telegram', 'whatsapp', etc.
  chatId    String // Platform-specific chat/channel ID
  username  String? // Display name from the platform
  isActive  Boolean  @default(true)
  metadata  Json? // Platform-specific extra data
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@unique([provider, chatId])
  @@map("connected_apps")
}

model HabitReminder {
  id        String   @id @default(uuid())
  habitId   String   @unique
  userId    String
  time      String // HH:mm in user's timezone
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("habit_reminders")
}

model UserNotificationSettings {
  id                  String   @id @default(uuid())
  userId              String   @unique
  dailySummaryEnabled Boolean  @default(false)
  dailySummaryTime    String? // HH:mm in user's timezone
  reminderEnabled     Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notification_settings")
}

// ============ ENUMS ============

enum Frequency {
  DAILY // Every day
  WEEKLY // Specific days or X times per week
}

enum HabitType {
  BOOLEAN // Yes/No - Did you do it?
  NUMERIC // Count - How many? (glasses of water)
  DURATION // Minutes - How long? (meditation time)
}

enum MilestoneType {
  STREAK // Consecutive days: 7, 14, 30, 60, 90, 180, 365
  COMPLETIONS // Total completions: 10, 25, 50, 100, 250, 500, 1000
}

enum BookStatus {
  WANT_TO_READ // In wishlist / TBR
  READING // Currently reading
  FINISHED // Completed
  ABANDONED // Gave up on it
}

enum ChallengeStatus {
  ACTIVE // In progress
  COMPLETED // Successfully finished
  FAILED // Didn't complete in time
  CANCELLED // User cancelled
}
